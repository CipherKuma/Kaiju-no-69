<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Algorithm Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }
        
        .card h2 {
            margin-bottom: 15px;
            color: #00d4ff;
            font-size: 1.2em;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .metric-label {
            color: #888;
        }
        
        .metric-value {
            font-weight: bold;
        }
        
        .positive {
            color: #4caf50;
        }
        
        .negative {
            color: #f44336;
        }
        
        .positions-table {
            width: 100%;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        th {
            background: #2a2a2a;
            color: #00d4ff;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .status.connected {
            background: #4caf50;
            color: white;
        }
        
        .status.disconnected {
            background: #f44336;
            color: white;
        }
        
        .log-container {
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 8px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .log-time {
            color: #666;
        }
        
        .log-type {
            font-weight: bold;
            margin-left: 10px;
        }
        
        .btn {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #00a8cc;
        }
        
        .controls {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Trading Algorithm Dashboard</h1>
        
        <div class="grid">
            <div class="card">
                <h2>Portfolio Overview</h2>
                <div class="metric">
                    <span class="metric-label">Portfolio Value:</span>
                    <span class="metric-value" id="portfolio-value">$0.00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Daily P&L:</span>
                    <span class="metric-value" id="daily-pnl">$0.00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Open Positions:</span>
                    <span class="metric-value" id="open-positions">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Connection:</span>
                    <span class="status disconnected" id="connection-status">Disconnected</span>
                </div>
            </div>
            
            <div class="card">
                <h2>Risk Metrics</h2>
                <div class="metric">
                    <span class="metric-label">Win Rate:</span>
                    <span class="metric-value" id="win-rate">0%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Sharpe Ratio:</span>
                    <span class="metric-value" id="sharpe-ratio">0.00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Max Drawdown:</span>
                    <span class="metric-value" id="max-drawdown">0%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Risk/Reward:</span>
                    <span class="metric-value" id="risk-reward">0.00</span>
                </div>
            </div>
            
            <div class="card">
                <h2>Market Activity</h2>
                <div class="metric">
                    <span class="metric-label">Last Analysis:</span>
                    <span class="metric-value" id="last-analysis">Never</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Signals Generated:</span>
                    <span class="metric-value" id="signals-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Market Condition:</span>
                    <span class="metric-value" id="market-condition">Unknown</span>
                </div>
                <div class="metric">
                    <span class="metric-label">AI Confidence:</span>
                    <span class="metric-value" id="ai-confidence">0%</span>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="forceAnalysis()">Force Analysis</button>
        </div>
        
        <div class="positions-table">
            <h2>Open Positions</h2>
            <table id="positions-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Entry Price</th>
                        <th>Current Price</th>
                        <th>P&L</th>
                        <th>P&L %</th>
                    </tr>
                </thead>
                <tbody id="positions-tbody">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666;">No open positions</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="log-container">
            <h2>Activity Log</h2>
            <div id="activity-log"></div>
        </div>
    </div>
    
    <script>
        let ws = null;
        const logEntries = [];
        const maxLogEntries = 50;
        
        function connect() {
            ws = new WebSocket('ws://localhost:3000');
            
            ws.onopen = () => {
                updateConnectionStatus(true);
                addLog('Connected to trading engine', 'info');
            };
            
            ws.onclose = () => {
                updateConnectionStatus(false);
                addLog('Disconnected from trading engine', 'error');
                setTimeout(connect, 5000); // Reconnect after 5 seconds
            };
            
            ws.onerror = (error) => {
                addLog('WebSocket error', 'error');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
        }
        
        function handleMessage(message) {
            switch (message.type) {
                case 'connected':
                    updateDashboard(message.data);
                    break;
                case 'marketUpdate':
                    addLog(`Market update: ${message.data.symbol} $${message.data.price}`, 'market');
                    break;
                case 'sentimentUpdate':
                    addLog(`Sentiment: ${message.data.symbol} ${message.data.score.toFixed(2)}`, 'sentiment');
                    break;
                case 'tradeExecuted':
                    addLog(`Trade: ${message.data.data.action} ${message.data.data.signal.symbol}`, 'trade');
                    fetchStatus();
                    break;
                case 'analysisComplete':
                    document.getElementById('last-analysis').textContent = new Date().toLocaleTimeString();
                    document.getElementById('signals-count').textContent = message.data.data.signalsGenerated;
                    if (message.data.data.aiDecision) {
                        document.getElementById('market-condition').textContent = 
                            message.data.data.aiDecision.marketCondition;
                        document.getElementById('ai-confidence').textContent = 
                            (message.data.data.aiDecision.confidence * 100).toFixed(0) + '%';
                    }
                    addLog(`Analysis complete: ${message.data.data.signalsGenerated} signals`, 'analysis');
                    break;
            }
        }
        
        function updateDashboard(data) {
            document.getElementById('portfolio-value').textContent = 
                '$' + data.portfolioValue.toFixed(2);
            document.getElementById('open-positions').textContent = data.positions;
            
            if (data.riskMetrics) {
                updateRiskMetrics(data.riskMetrics);
            }
        }
        
        function updateRiskMetrics(metrics) {
            document.getElementById('win-rate').textContent = 
                metrics.winRate.toFixed(1) + '%';
            document.getElementById('sharpe-ratio').textContent = 
                metrics.sharpeRatio.toFixed(2);
            document.getElementById('max-drawdown').textContent = 
                metrics.maxDrawdown.toFixed(1) + '%';
            document.getElementById('risk-reward').textContent = 
                metrics.riskRewardRatio.toFixed(2);
            
            const dailyPnl = document.getElementById('daily-pnl');
            dailyPnl.textContent = '$' + metrics.dailyPnL.toFixed(2);
            dailyPnl.className = metrics.dailyPnL >= 0 ? 'metric-value positive' : 'metric-value negative';
        }
        
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            status.textContent = connected ? 'Connected' : 'Disconnected';
            status.className = connected ? 'status connected' : 'status disconnected';
        }
        
        function addLog(message, type) {
            const time = new Date().toLocaleTimeString();
            logEntries.unshift({ time, message, type });
            
            if (logEntries.length > maxLogEntries) {
                logEntries.pop();
            }
            
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logContainer = document.getElementById('activity-log');
            logContainer.innerHTML = logEntries.map(entry => `
                <div class="log-entry">
                    <span class="log-time">${entry.time}</span>
                    <span class="log-type" style="color: ${getLogColor(entry.type)}">[${entry.type}]</span>
                    ${entry.message}
                </div>
            `).join('');
        }
        
        function getLogColor(type) {
            const colors = {
                info: '#00d4ff',
                error: '#f44336',
                trade: '#4caf50',
                market: '#ff9800',
                sentiment: '#9c27b0',
                analysis: '#2196f3'
            };
            return colors[type] || '#666';
        }
        
        async function fetchStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                updateDashboard(data);
                
                // Fetch positions
                const positionsResponse = await fetch('/positions');
                const positionsData = await positionsResponse.json();
                updatePositionsTable(positionsData.positions);
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }
        
        function updatePositionsTable(positions) {
            const tbody = document.getElementById('positions-tbody');
            
            if (positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No open positions</td></tr>';
                return;
            }
            
            tbody.innerHTML = positions.map(pos => {
                const pnlClass = pos.pnl >= 0 ? 'positive' : 'negative';
                return `
                    <tr>
                        <td>${pos.symbol}</td>
                        <td>${pos.side}</td>
                        <td>$${pos.entryPrice.toFixed(2)}</td>
                        <td>$${pos.currentPrice.toFixed(2)}</td>
                        <td class="${pnlClass}">$${pos.pnl.toFixed(2)}</td>
                        <td class="${pnlClass}">${pos.pnlPercentage.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function forceAnalysis() {
            try {
                const response = await fetch('/analyze', { method: 'POST' });
                const data = await response.json();
                addLog('Manual analysis triggered', 'info');
            } catch (error) {
                addLog('Failed to trigger analysis', 'error');
            }
        }
        
        // Initialize
        connect();
        fetchStatus();
        setInterval(fetchStatus, 10000); // Update every 10 seconds
    </script>
</body>
</html>